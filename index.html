<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>College Timetable</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --muted: #9ca3af;
        --text: #e5e7eb;
        --grid-line: #1f2937;
        --hour-line: #293445;
        --accent: #22c55e;
        --danger: #ef4444;
        --border: #2a3344;
        --label-w: 120px;
      }

      * { box-sizing: border-box; }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        background: radial-gradient(1200px 800px at 0% 0%, #0b1220 0%, var(--bg) 45%, #0d1626 100%);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell,
          Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        line-height: 1.4;
        padding-bottom: env(safe-area-inset-bottom, 0px);
      }

      header {
        padding: calc(18px + env(safe-area-inset-top, 0px)) 20px 18px 20px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0)) 0 0/100% 1px no-repeat;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      header h1 {
        margin: 0 0 6px 0;
        font-size: 20px;
        letter-spacing: 0.2px;
      }
      header p { margin: 0; color: var(--muted); font-size: 13px; }

      .container {
        max-width: 100%;
        margin: 0 auto;
        padding: 16px;
        display: grid;
        grid-template-columns: clamp(260px, 26vw, 360px) 1fr;
        gap: 16px;
        align-items: start;
      }

      .panel {
        background: rgba(17, 24, 39, 0.75);
        border: 1px solid var(--border);
        border-radius: 12px;
        backdrop-filter: blur(6px);
        overflow: hidden;
        position: relative;
        z-index: 1;
        min-width: 0;
      }

      .controls { padding: 14px; overflow: hidden; min-width: 0; }
      .controls h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; max-width: 100%; }
      label { font-size: 13px; color: var(--muted); }
      input[type="text"], input[type="time"], select, input[type="color"] {
        background: #0b1220;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 14px;
        outline: none;
      }
      input[type="time"] { padding-right: 4px; width: 96px; }
      input[type="color"] { padding: 2px; width: 46px; height: 34px; }
      select { min-width: 96px; }
      .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
      .chip {
        user-select: none;
        text-align: center;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0b1220;
        font-size: 13px;
        cursor: pointer;
      }
      .chip.active { background: #152238; border-color: #37517e; color: #cfe3ff; }

      .btn {
        background: linear-gradient(180deg, #1a9f55, #168a4a);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        cursor: pointer;
      }
      .btn.secondary {
        background: #0b1220;
        border: 1px solid var(--border);
        color: var(--text);
      }
      .btn.danger { background: linear-gradient(180deg, #ef4444, #d33939); }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }

      .events-list { padding: 0 14px 14px 14px; overflow: hidden; min-width: 0; }
      .events-list h3 { margin: 0 0 10px 0; font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; }
      .event-item {
        display: block; gap: 8px; align-items: center;
        padding: 8px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; background: #0b1220;
      }
      .event-summary { font-size: 13px; color: #cbd5e1; }
      .event-actions button { margin-left: 6px; }

      /* Tabs */
      .tabs { display: flex; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(17,24,39,0.9); z-index: 2; }
      .tab-btn {
        padding: 10px 12px;
        background: transparent;
        color: var(--muted);
        border: none;
        cursor: pointer;
        font-weight: 600;
      }
      .tab-btn.active { color: #e2f3ff; border-bottom: 2px solid #60a5fa; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }

      /* Accordion for add-class form */
      .accordion { overflow: hidden; max-height: 0; transition: max-height 240ms ease; border-top: 1px solid var(--border); }
      .accordion.open { /* max-height is set inline via JS for smooth height */ max-height: 9999px; }

      /* Center modal card */
      .modal-backdrop {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5);
        display: none; align-items: center; justify-content: center;
        z-index: 50;
      }
      .modal-backdrop.open { display: flex; }
      .modal-card {
        width: min(720px, 92vw);
        background: rgba(17, 24, 39, 0.98);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        padding-bottom: env(safe-area-inset-bottom, 0px);
      }
      .modal-header { display:flex; align-items:center; justify-content:space-between; padding: 14px; border-bottom: 1px solid var(--border); }
      .modal-body { padding: 0 14px 14px 14px; }
      .slot-card { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; padding:10px; border:1px solid var(--border); border-radius:10px; background:#0b1220; }
      .slot-main { display:flex; flex-direction:column; }
      .slot-title { font-weight:600; color:#dbe7ff; }
      .slot-meta { color: var(--muted); font-size: 12px; margin-top: 2px; }
      .slot-actions button { margin-left: 6px; }
      .slot-notes { color:#bcd0ff; font-size:12px; margin-top:6px; white-space:pre-wrap; }
      .notes-list { display:flex; flex-direction:column; gap:8px; }
      .note-item { display:flex; align-items:flex-start; gap:8px; padding:8px; border:1px solid var(--border); border-radius:8px; background:#0b1220; }
      .note-text { flex:1; white-space:pre-wrap; color:#dbe7ff; font-size:13px; }
      .note-del { background:#0b1220; color:var(--muted); border:1px solid var(--border); border-radius:8px; padding:6px 8px; cursor:pointer; }
      .note-del:hover { color:#e2f3ff; border-color:#37517e; }
      /* Auth improvements */
      .auth-card { max-width: 520px; width: 92vw; }
      .auth-tabs { display:flex; gap:4px; margin-bottom:10px; }
      .auth-tab { flex:1; padding:10px 12px; border:1px solid var(--border); background:#0b1220; color:var(--muted); border-radius:8px; cursor:pointer; text-align:center; }
      .auth-tab.active { background:#152238; color:#e2f3ff; border-color:#37517e; }
      .auth-error { color:#ffb4b4; background:#3b1f1f; border:1px solid #6b2a2a; padding:8px; border-radius:8px; display:none; }
      .auth-actions { display:flex; gap:8px; align-items:center; }
      .auth-foot { color:var(--muted); font-size:12px; margin-top:6px; }
      .field-row { display:flex; gap:8px; align-items:center; }
      .field-row label { color:var(--muted); font-size:12px; }
      .icon-btn { width: 36px; height: 34px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--muted); display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
      .icon-btn:hover { color: #e2f3ff; border-color: #37517e; background: #0b1220; }
      .icon-btn svg { width: 18px; height: 18px; display: block; }
       /* Notes pane */
       .notes-pane.panel { padding: 8px; display: none; }
       .notes-editor { display: flex; flex-direction: column; gap: 12px; height: calc(100vh - 160px); }
       .doc { background: rgba(11,18,32,0.9); border: 1px solid var(--border); border-radius: 12px; padding: 12px; overflow: auto; }
       .doc input.note-title { width: 100%; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px; font-size:16px; margin-bottom:8px; }
       .doc textarea#noteContent { width: 100%; height: calc(100% - 56px); background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px; resize: none; }
       .note-list-item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border:1px solid var(--border); border-radius:8px; background:#0b1220; margin-bottom:8px; }
       .note-title-mini { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      @media (max-width: 600px) {
        .modal-backdrop.open { align-items: flex-end; }
        .modal-card { width: 100%; border-radius: 12px 12px 0 0; }
          .notes-editor { height: auto; }
      }

      /* Timetable (horizontal time, days on left) */
             .timetable.panel { padding: 8px; overflow: auto; z-index: 0; position: relative; }
       .tt-scroll { width: 100%; overflow: auto; }
       .legend-top { display: grid; grid-template-columns: var(--label-w) 1fr; align-items: stretch; gap: 0; }
       .legend-top .corner { height: 36px; border-right: 1px solid var(--border); }
       .legend-top .times { position: relative; height: 36px; display: grid; grid-auto-flow: column; gap: 0; }
       .legend-time-cell { width: var(--step-px, 48px); border-left: 1px solid var(--grid-line); color: var(--muted); font-size: 12px; text-align: center; line-height: 36px; }
 
       .rows { display: grid; gap: 0; }
       .day-line { display: grid; grid-template-columns: var(--label-w) 1fr; align-items: stretch; min-height: 56px; }
       .day-label { display: flex; align-items: center; justify-content: flex-end; padding: 0 10px; color: #cbd5e1; border-right: 1px solid var(--border); font-weight: 600; }
       .day-row { position: relative; min-height: 56px; background: rgba(11, 18, 32, 0.6); }
       .day-row::before {
        content: "";
        position: absolute; inset: 0;
        background: repeating-linear-gradient(to right,
          transparent 0,
          transparent calc(var(--step-px, 48px) - 1px),
          rgba(255,255,255,0.04) calc(var(--step-px, 48px) - 1px),
          rgba(255,255,255,0.04) var(--step-px, 48px)
        );
        pointer-events: none;
      }

             .event-block {
         position: absolute;
         top: 6px;
         height: calc(100% - 12px);
         border-radius: 10px;
         padding: 8px;
         color: #0b1220;
         font-weight: 600;
         font-size: 12px;
         box-shadow: 0 6px 16px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
         border: 1px solid rgba(0,0,0,0.2);
         overflow: hidden;
         text-overflow: ellipsis;
         cursor: pointer;
         transition: transform 120ms ease, box-shadow 120ms ease;
       }
      .event-block:active { transform: scale(0.98); box-shadow: 0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2); }
      .event-block .subtitle { display: block; font-size: 11px; opacity: 0.85; font-weight: 500; }

      .footer {
        color: var(--muted);
        font-size: 12px;
        padding: 10px 14px 14px 14px;
      }

      @media (max-width: 980px) {
        .container { grid-template-columns: 1fr; }
        :root { --label-w: 90px; }
      }

      /* Light theme overrides */
      [data-theme="light"] {
        --bg: #f8fafc;
        --panel: #ffffff;
        --muted: #475569;
        --text: #0f172a;
        --grid-line: #e5e7eb;
        --hour-line: #cbd5e1;
        --accent: #16a34a;
        --danger: #dc2626;
        --border: #e2e8f0;
      }
      [data-theme="light"] body {
        background: radial-gradient(1200px 800px at 0% 0%, #ffffff 0%, var(--bg) 45%, #eef2f7 100%);
        color: var(--text);
      }
      [data-theme="light"] .panel { background: rgba(255,255,255,0.85); }
      [data-theme="light"] .tabs { background: rgba(255,255,255,0.9); border-bottom-color: var(--border); }
      [data-theme="light"] .tab-btn { color: var(--muted); }
      [data-theme="light"] .tab-btn.active { color: #0f172a; border-bottom-color: #3b82f6; }
      [data-theme="light"] .btn.secondary { background: #ffffff; color: var(--text); border-color: var(--border); }
      [data-theme="light"] .event-item { background: #ffffff; border-color: var(--border); }
      [data-theme="light"] .modal-card { background: #ffffff; }
      [data-theme="light"] .slot-card { background: #ffffff; border-color: var(--border); }
      [data-theme="light"] .day-label { color: #334155; border-right-color: var(--border); }
      [data-theme="light"] .day-row { background: rgba(255,255,255,0.6); }
      [data-theme="light"] .chip { background: #ffffff; color: var(--text); border-color: var(--border); }
      [data-theme="light"] .chip.active { background: #e8f0ff; border-color: #93c5fd; color: #0f172a; }
      [data-theme="light"] input[type="text"],
      [data-theme="light"] input[type="email"],
      [data-theme="light"] input[type="password"],
      [data-theme="light"] input[type="time"],
      [data-theme="light"] select,
      [data-theme="light"] input[type="color"],
      [data-theme="light"] textarea {
        background: #ffffff !important;
        color: var(--text) !important;
        border-color: var(--border) !important;
      }
      [data-theme="light"] .icon-btn { color: var(--muted); border-color: var(--border); background: #ffffff; }
      [data-theme="light"] .icon-btn:hover { color: #0f172a; border-color: #93c5fd; background: #ffffff; }
      [data-theme="light"] .auth-tab { background:#ffffff; color: var(--muted); border-color: var(--border); }
      [data-theme="light"] .auth-tab.active { background:#e8f0ff; color:#0f172a; border-color:#93c5fd; }

      /* Timetable quality-of-life */
      .timetable.panel .tt-scroll { -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; }
      .timetable.panel .legend-top { position: sticky; top: 0; z-index: 1; background: rgba(17,24,39,0.9); backdrop-filter: blur(4px); }
      [data-theme="light"] .timetable.panel .legend-top { background: rgba(255,255,255,0.9); }

      /* Mobile tweaks */
      @media (max-width: 600px) {
        :root { --label-w: 64px; }
        header { padding: 12px; }
        header h1 { font-size: 18px; }
                 .container { padding: 8px; gap: 8px; }
         .controls { padding: 12px; }
         .events-list { padding: 0 12px 12px 12px; }
         .row { flex-direction: column; align-items: stretch; gap: 8px; }
         .field-row { flex-direction: column; align-items: stretch; gap: 6px; }
         .auth-actions { flex-direction: column; }
         .auth-actions .btn { width: 100%; }
         input[type="time"], select { width: 100%; min-width: 0; }
         input[type="color"] { width: 56px; height: 36px; }
         .days { grid-auto-flow: column; grid-template-columns: repeat(7, max-content); overflow-x: auto; -webkit-overflow-scrolling: touch; gap: 8px; padding-bottom: 6px; }
         .chip { min-width: 56px; }
         .legend-time-cell { font-size: 12px; }
         .day-label { font-size: 12px; }
         .event-block { font-size: 12px; padding: 8px; white-space: normal; overflow-wrap: anywhere; }
         .event-block .subtitle { display: none; }
         .event-block .subtitle:last-child { display: block; }
         .day-row { min-height: 72px; }
         .legend-top .corner { height: 44px; }
         .legend-time-cell { line-height: 44px; }
         .tab-btn { padding: 10px; font-size: 13px; }
         .slot-card { flex-direction: column; }
         .slot-actions { display: flex; gap: 6px; }
         .slot-actions .btn { flex: 1; }
      }

      .tt-scroll { touch-action: pan-x; }
 
       /* Right-side details drawer */
       .drawer-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 55; display: none; }
       .drawer-backdrop.open { display: block; }
       .side-drawer { position: fixed; top: 0; right: 0; height: 100%; width: min(720px, 50vw); background: var(--panel); border-left: 1px solid var(--border); box-shadow: -16px 0 40px rgba(0,0,0,0.35); transform: translateX(100%); transition: transform 220ms ease; z-index: 60; display: flex; flex-direction: column; }
       .side-drawer.open { transform: translateX(0); }
       .drawer-header { display:flex; align-items:center; justify-content:space-between; padding: 14px; border-bottom:1px solid var(--border); }
       .drawer-body { padding: 12px 14px 14px 14px; overflow: auto; flex: 1; }
       @media (max-width: 600px) { .side-drawer { width: 100%; } }
    </style>
  </head>
  <body>
    <header>
      <h1>workflow</h1>
      <button id="themeToggle" class="icon-btn" aria-label="Toggle theme" title="Toggle theme"></button>
    </header>

    <div class="container">
      <div class="panel">
        <div id="accountBar" style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border);">
          <span id="accountLabel" style="color:var(--muted); font-size:12px;">Not signed in</span>
          <button id="logoutBtn" class="btn secondary" style="display:none;">Logout</button>
        </div>
         <div class="tabs">
           <button class="tab-btn active" data-tab="tab-timetable">Timetable</button>
           <button class="tab-btn" data-tab="tab-classes">Classes</button>
           <button class="tab-btn" data-tab="tab-notes">Notes</button>
         </div>

        <div id="tab-timetable" class="tab-content active">
          <div class="controls">
            <h3>Timetable Settings</h3>
            <div class="row">
              <label for="startTime">Start</label>
              <input id="startTime" type="time" value="08:00" />
              <label for="endTime">End</label>
              <input id="endTime" type="time" value="18:00" />
              <button id="applyTime" class="btn">Apply</button>
            </div>
            <div class="row" style="align-items:flex-start;">
              <label style="margin-top:8px;">Days</label>
              <div id="daysChooser" class="days"></div>
            </div>
          </div>
        </div>

        <div id="tab-classes" class="tab-content">
          <div class="controls">
            <h3>Classes</h3>
            <div class="row" style="justify-content: space-between;">
              <span style="color:var(--muted); font-size:13px;">Manage your classes and add time slots.</span>
              <button id="openAddModal" class="btn secondary">+ Add class</button>
            </div>
          </div>
          <div class="events-list">
            <h3>Classes</h3>
            <div id="eventsContainer"></div>
          </div>
        </div>

        <div id="tab-notes" class="tab-content">
          <div class="controls">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <h3 style="margin:0;">Notes</h3>
              <button id="addGlobalNote" class="btn secondary" title="New note" style="display:inline-flex; align-items:center; gap:8px;">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                  <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                New Note
              </button>
            </div>
            <div class="events-list" style="padding-left:0; padding-right:0; max-height: 38vh; overflow:auto;">
              <div id="notesListGlobal"></div>
            </div>
          </div>
        </div>

        <div class="footer">
          Tip: Add the same class multiple times on the same day. Adjacent or overlapping times auto-merge into a single block.
        </div>
      </div>

       <div class="timetable panel" id="ttPanel">
        <div class="tt-scroll">
          <div class="legend-top">
            <div class="corner"></div>
            <div class="times" id="legendTimes"></div>
          </div>
          <div class="rows" id="rows"></div>
        </div>
      </div>
 
       <div class="notes-pane panel" id="notesPanel">
         <div class="controls">
           <div class="row" style="align-items:flex-start; gap:12px;">
             <div style="flex:1; min-width:100%;">
               <div class="notes-editor" style="max-width: 980px; margin: 0 auto;">
                 <div class="doc">
                   <div class="row" style="gap:8px; align-items:center;">
                     <input id="noteTitle" class="note-title" placeholder="Title" />
                     <select id="noteClass" title="Related class" style="min-width:160px;">
                       <option value="">No class</option>
                     </select>
                   </div>
                   <textarea id="noteContent" placeholder="Write your note..." style="min-height: 220px;"></textarea>
                 </div>
               </div>
               <div class="row" style="justify-content:flex-end; gap:8px; margin-top:10px;">
                 <button id="deleteGlobalNote" class="btn secondary">Delete</button>
                 <button id="saveGlobalNote" class="btn">Save</button>
               </div>
             </div>
           </div>
         </div>
       </div>
    </div>

    <!-- Add Class Modal -->
    <div id="modal" class="modal-backdrop" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-header">
          <strong>Add Class</strong>
          <button id="closeModal" class="btn secondary">Close</button>
        </div>
        <div class="modal-body">
          <div class="row" style="gap:10px;">
            <input id="className" type="text" placeholder="Class name (e.g., Calculus)" style="flex:2; min-width:160px;" />
            <input id="teacherName" type="text" placeholder="Teacher name" style="flex:1; min-width:140px;" />
            <input id="location" type="text" placeholder="Location" style="flex:1; min-width:140px;" />
          </div>
          <div class="row" style="flex-direction:column; align-items:stretch; gap:6px;">
            <label for="notes" style="color:var(--muted); font-size:12px;">Notes (optional)</label>
            <textarea id="notes" rows="3" placeholder="Any notes for this class (e.g., materials, meeting link)" style="resize:vertical; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px;"></textarea>
          </div>
          <div class="row" style="flex-direction: column; align-items: stretch; gap: 8px;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <label>Time slots</label>
              <button id="addSlot" type="button" class="btn secondary">+ Add time slot</button>
            </div>
            <div id="timeSlots" style="display:flex; flex-direction:column; gap:8px;"></div>
          </div>
          <div class="row">
            <label for="classColor">Color</label>
            <input id="classColor" type="color" value="#60a5fa" />
            <button id="addClass" class="btn">Add</button>
            <button id="clearAll" class="btn danger" title="Remove all classes">Clear All</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right-side Editor Drawer -->
    <div id="drawerBackdrop" class="drawer-backdrop" aria-hidden="true"></div>
    <aside id="editorDrawer" class="side-drawer" aria-hidden="true">
      <div class="drawer-header">
        <strong>Edit Class</strong>
        <button id="closeDrawer" class="btn secondary">Close</button>
      </div>
      <div class="drawer-body">
        <div class="row">
          <input id="editName" type="text" placeholder="Class name" style="flex:2; min-width:160px;" />
          <input id="editTeacher" type="text" placeholder="Teacher" style="flex:1; min-width:140px;" />
          <input id="editLocation" type="text" placeholder="Location" style="flex:1; min-width:140px;" />
        </div>
        <div class="row" style="gap:8px;">
          <label>Color</label>
          <input id="editColor" type="color" />
        </div>
        <div class="row" style="flex-direction: column; align-items: stretch; gap: 8px;">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <label>Time slots</label>
            <button id="addEditSlot" type="button" class="btn secondary">+ Add time slot</button>
          </div>
          <div id="editTimeSlots" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>
        <div class="row" style="flex-direction:column; align-items:stretch; gap:8px;">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <label>Class notes</label>
            <div>
              <button id="addNote" class="btn secondary">+ Add note</button>
            </div>
          </div>
          <div id="notesList" class="notes-list"></div>
          <div id="linkedNotes" class="notes-list" style="margin-top:6px;"></div>
        </div>
        <div class="row" style="justify-content:flex-end; gap:8px;">
          <button id="deleteOne" class="btn secondary">Delete</button>
          <button id="saveOne" class="btn">Save changes</button>
        </div>
      </div>
    </aside>

    <!-- Auth Modal -->
    <div id="authModal" class="modal-backdrop open" aria-hidden="false">
      <div class="modal-card auth-card">
        <div class="modal-header"><strong id="authTitle">Welcome</strong></div>
        <div class="modal-body">
          <div class="auth-tabs">
            <div id="tabSignIn" class="auth-tab active">Sign in</div>
            <div id="tabSignUp" class="auth-tab">Create account</div>
          </div>
          <div id="authError" class="auth-error"></div>
          <div class="row" style="flex-direction:column; align-items:stretch; gap:8px;">
            <div id="nameRow" class="field-row" style="display:none;">
              <label style="min-width:80px;">Name</label>
              <input id="authName" type="text" placeholder="Your name" style="flex:1; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px;" />
            </div>
            <div class="field-row">
              <label style="min-width:80px;">Email</label>
              <input id="authEmail" type="email" placeholder="you@example.com" style="flex:1; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px;" />
            </div>
            <div class="field-row">
              <label style="min-width:80px;">Password</label>
              <input id="authPassword" type="password" placeholder="••••••••" style="flex:1; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px;" />
              <button id="togglePassword" type="button" class="icon-btn" aria-label="Show password" title="Show password"></button>
            </div>
            <div class="auth-actions">
              <button id="authSubmit" class="btn" style="flex:1;">Continue</button>
              <button id="authCancel" class="btn secondary" style="flex:1;">Cancel</button>
            </div>
            <div class="auth-foot">
              Tip: your data syncs to your account (phone and desktop) when signed in.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase (fill your config below) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

    <script>
      // 1) Firebase config (from your message)
      // If you need to revert to local demo storage, set FIREBASE_CONFIG to null
      window.FIREBASE_CONFIG = {
        apiKey: "AIzaSyAsgMCTtlLNLYVAp4GvdlR0nqcrjTZHEY8",
        authDomain: "timetable-e3cf3.firebaseapp.com",
        projectId: "timetable-e3cf3",
        storageBucket: "timetable-e3cf3.firebasestorage.app",
        messagingSenderId: "465206434019",
        appId: "1:465206434019:web:1f4cdeee0bcb72303c4dd6",
        measurementId: "G-XR9CC9X9WL"
      };
      const DAYS_ALL = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
       const STORAGE_KEYS = { settings: "tt_settings", events: "tt_events", notes: "tt_notes" };
      const AUTH_KEYS = { user: 'tt_user', users: 'tt_users' }; // demo local auth
      let fb = { app: null, auth: null, db: null };

      function timeToMinutes(hhmm) {
        const [h, m] = hhmm.split(":").map(Number);
        return h * 60 + m;
      }
      function minutesToTime(min) {
        let h = Math.floor(min / 60) % 24;
        const m = min % 60;
        const suffix = h >= 12 ? "PM" : "AM";
        const h12 = h % 12 === 0 ? 12 : h % 12;
        return `${h12}:${String(m).padStart(2, "0")} ${suffix}`;
      }
      // Kept for internal computations where needed
      function minutesToAmPm(min) { return minutesToTime(min); }
      function clamp(val, a, b) { return Math.min(Math.max(val, a), b); }
      function getLabelWidthPx() {
        const value = getComputedStyle(document.documentElement)
          .getPropertyValue('--label-w')
          .trim();
        const match = value.match(/([0-9.]+)px/);
        return match ? parseFloat(match[1]) : 120;
      }

      function loadSettings() {
        const saved = localStorage.getItem(STORAGE_KEYS.settings);
        if (saved) {
          try { return JSON.parse(saved); } catch {}
        }
        return {
          start: "08:00",
          end: "18:00",
          activeDays: [...DAYS_ALL],
          rowMinutes: 30,
        };
      }
      function saveSettings(s) {
        localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(s));
      }
       async function loadEvents() {
        if (fb.db && currentUser?.uid) {
          const snap = await fb.db.collection('events').where('uid','==',currentUser.uid).get();
          const arr = [];
          snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
          // Map firestore docs to our shape
          return arr.map(e => ({
            id: e.id,
            name: e.name,
            day: e.day,
            start: e.start,
            end: e.end,
            color: e.color,
            teacher: e.teacher || '',
            location: e.location || '',
            mode: e.mode || 'Lecture',
            notes: e.notes || ''
          }));
        }
        const key = STORAGE_KEYS.events + (currentUser?.email ? ':' + currentUser.email : '');
        const saved = localStorage.getItem(key);
        if (saved) { try { return JSON.parse(saved); } catch {} }
        return [];
      }
       async function loadNotes() {
         // Cloud-only: requires signed-in user and Firestore
         if (fb.db && currentUser?.uid) {
           const snap = await fb.db.collection('notes').where('uid','==',currentUser.uid).get();
           const arr = []; snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
           return arr
             .map(n=>({ id: n.id, title: n.title||'Untitled', content: n.content||'', className: n.className||'', updatedAt: n.updatedAt||0 }))
             .sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
         }
         return [];
       }
       async function saveEvents(list) {
        if (fb.db && currentUser?.uid) {
          // naive sync: clear and re-add (simple for demo). For prod, do granular updates
          const batch = fb.db.batch();
          const ref = fb.db.collection('events');
          // delete existing for uid
          const exist = await fb.db.collection('events').where('uid','==',currentUser.uid).get();
          exist.forEach(d => batch.delete(d.ref));
          list.forEach(ev => {
            const docRef = ref.doc();
            batch.set(docRef, { uid: currentUser.uid, ...ev });
          });
          await batch.commit();
          return;
        }
        const key = STORAGE_KEYS.events + (currentUser?.email ? ':' + currentUser.email : '');
        localStorage.setItem(key, JSON.stringify(list));
      }
       async function saveNotes(list) {
         if (!(fb.db && currentUser?.uid)) {
           alert('Please sign in to save notes to the cloud.');
           return false;
         }
         // Cloud-only upsert
         const ref = fb.db.collection('notes');
         for (const n of list) {
           const docRef = ref.doc(n.id);
           await docRef.set({ uid: currentUser.uid, title: n.title||'Untitled', content: n.content||'', className: n.className||'', updatedAt: n.updatedAt||Date.now() }, { merge: true });
         }
         return true;
       }

      let settings = loadSettings();
       let events = [];
       let notesGlobal = [];
       let activeNoteId = null;
      let currentUser = null;

      // UI Elements
      const startTimeEl = document.getElementById("startTime");
      const endTimeEl = document.getElementById("endTime");
      const applyTimeBtn = document.getElementById("applyTime");
      const daysChooser = document.getElementById("daysChooser");
      const classNameEl = document.getElementById("className");
      const addSlotBtn = document.getElementById("addSlot");
      const timeSlotsEl = document.getElementById("timeSlots");
      const classColorEl = document.getElementById("classColor");
      const addClassBtn = document.getElementById("addClass");
      const clearAllBtn = document.getElementById("clearAll");
      const eventsContainer = document.getElementById("eventsContainer");
      const legendTimesEl = document.getElementById("legendTimes");
      const rowsEl = document.getElementById("rows");
      const ttPanel = document.getElementById('ttPanel');
      const notesPanel = document.getElementById('notesPanel');
      const tabButtons = document.querySelectorAll('.tab-btn');
      const ttScroll = document.querySelector('.tt-scroll');
      const openAddModalBtn = document.getElementById('openAddModal');
      const modal = document.getElementById('modal');
      const closeModalBtn = document.getElementById('closeModal');
      // Drawer elements
      const drawer = document.getElementById('editorDrawer');
      const drawerBackdrop = document.getElementById('drawerBackdrop');
      const closeDrawerBtn = document.getElementById('closeDrawer');
      const editName = document.getElementById('editName');
      const editTeacher = document.getElementById('editTeacher');
      const editLocation = document.getElementById('editLocation');
      const editColor = document.getElementById('editColor');
      const editTimeSlotsEl = document.getElementById('editTimeSlots');
      const addEditSlotBtn = document.getElementById('addEditSlot');
      const notesListEl = document.getElementById('notesList');
      const linkedNotesEl = document.getElementById('linkedNotes');
      const addNoteBtn = document.getElementById('addNote');
      const saveOneBtn = document.getElementById('saveOne');
      const deleteOneBtn = document.getElementById('deleteOne');
      let editingIndex = null; // index in events array
      const authModal = document.getElementById('authModal');
      const authEmail = document.getElementById('authEmail');
      const authPassword = document.getElementById('authPassword');
      const authSubmit = document.getElementById('authSubmit');
      const authCancel = document.getElementById('authCancel');
      const authName = document.getElementById('authName');
      const nameRow = document.getElementById('nameRow');
      const authError = document.getElementById('authError');
      const tabSignIn = document.getElementById('tabSignIn');
      const tabSignUp = document.getElementById('tabSignUp');
      const authTitle = document.getElementById('authTitle');
      const accountLabel = document.getElementById('accountLabel');
      const logoutBtn = document.getElementById('logoutBtn');
      const togglePasswordBtn = document.getElementById('togglePassword');
      // Global notes elements
      const addGlobalNoteBtn = document.getElementById('addGlobalNote');
      const notesListGlobalEl = document.getElementById('notesListGlobal');
      const noteTitleEl = document.getElementById('noteTitle');
      const noteContentEl = document.getElementById('noteContent');
      const notePreviewEl = null;
      const noteClassEl = document.getElementById('noteClass');
      const saveGlobalNoteBtn = document.getElementById('saveGlobalNote');
      const deleteGlobalNoteBtn = document.getElementById('deleteGlobalNote');
      let isPasswordVisible = false;
      function renderPasswordToggle() {
        togglePasswordBtn.innerHTML = isPasswordVisible
          ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.66 21.66 0 0 1 5.06-5.88"/><path d="M1 1l22 22"/><path d="M9.88 9.88A3 3 0 0 0 15 12c0 .86-.36 1.64-.94 2.2"/></svg>'
          : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg>';
        const label = isPasswordVisible ? 'Hide password' : 'Show password';
        togglePasswordBtn.setAttribute('aria-label', label);
        togglePasswordBtn.setAttribute('title', label);
      }
      togglePasswordBtn.addEventListener('click', () => {
        isPasswordVisible = !isPasswordVisible;
        authPassword.type = isPasswordVisible ? 'text' : 'password';
        renderPasswordToggle();
      });
      renderPasswordToggle();

      // Theme toggle
      const THEME_KEY = 'tt_theme';
      const themeToggleBtn = document.getElementById('themeToggle');
      function getInitialTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        if (saved === 'light' || saved === 'dark') return saved;
        return (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';
      }
      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem(THEME_KEY, theme);
      }
      let currentTheme = getInitialTheme();
      function renderThemeToggle() {
        const isDark = currentTheme === 'dark';
        themeToggleBtn.innerHTML = isDark
          ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12Zm0 4a1 1 0 0 1-1-1v-1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm0-18a1 1 0 0 1-1-1V2a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm10 8a1 1 0 0 1-1 1h-1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1ZM4 12a1 1 0 0 1-1 1H2a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm14.95 7.364a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414ZM7.172 6.343a1 1 0 0 1-1.414 0l-.707-.707A1 1 0 1 1 6.465 4.222l.707.707a1 1 0 0 1 0 1.414Zm11.314-1.414a1 1 0 0 1 0 1.414l-.707.707A1 1 0 1 1 16.364 5.95l.707-.707a1 1 0 0 1 1.414 0ZM6.343 18.364a1 1 0 0 1 0-1.414l.707-.707a1 1 0 1 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414 0Z"/></svg>'
          : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"/></svg>';
        const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';
        themeToggleBtn.setAttribute('aria-label', label);
        themeToggleBtn.setAttribute('title', label);
      }
      themeToggleBtn.addEventListener('click', () => {
        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(currentTheme);
        renderThemeToggle();
      });
      applyTheme(currentTheme);
      renderThemeToggle();

      // Firebase setup (if config present)
      (function initFirebase(){
        if (!window.FIREBASE_CONFIG) return;
        try {
          fb.app = firebase.initializeApp(window.FIREBASE_CONFIG);
          fb.auth = firebase.auth();
          fb.db = firebase.firestore();
          console.log('Firebase initialized');
        } catch (e) { console.warn('Firebase init failed or already initialized', e); }
      })();

      // Demo auth (localStorage) fallback. If Firebase enabled, use Firebase Auth
      function setUser(user) {
        currentUser = user;
        if (user) {
          accountLabel.textContent = `Signed in as ${user.email}`;
          logoutBtn.style.display = '';
          // Load user-specific data (keyed by uid/email)
       Promise.resolve(loadEvents()).then((e) => { events = e; renderEventsList(); renderTimetable(); });
       Promise.resolve(loadNotes()).then(async (n) => {
         notesGlobal = n;
         // One-time migration: merge any local notes for this email into Firestore
         try {
           if (fb.db && currentUser?.uid) {
             const localKey = STORAGE_KEYS.notes + ':' + currentUser.email;
             const raw = localStorage.getItem(localKey);
             if (raw) {
               try {
                 const localArr = JSON.parse(raw) || [];
                 if (Array.isArray(localArr) && localArr.length) {
                   // Merge unique by id; create IDs if missing
                   const existingById = new Map(notesGlobal.map(x => [x.id, x]));
                   localArr.forEach(x => {
                     const id = x.id || (x.id = crypto.randomUUID());
                     const merged = {
                       id,
                       title: x.title || 'Untitled',
                       content: x.content || '',
                       className: x.className || '',
                       updatedAt: x.updatedAt || Date.now(),
                     };
                     existingById.set(id, merged);
                   });
                   notesGlobal = Array.from(existingById.values());
                   await saveNotes(notesGlobal);
                   localStorage.removeItem(localKey);
                 }
               } catch {}
             }
             // Reload from cloud after potential migration
             try { notesGlobal = await loadNotes(); } catch {}
           }
         } catch(e) { console.warn('Notes migration check failed', e); }
         renderNotesListGlobal();
         if (notesGlobal.length) { openNote(notesGlobal[0].id); } else { clearNoteEditor(); }
       });
        } else {
          accountLabel.textContent = 'Not signed in';
          logoutBtn.style.display = 'none';
        }
        // Populate class selector for notes whenever user context changes
        populateNoteClassOptions();
      }
      function getUsers() {
        try { return JSON.parse(localStorage.getItem(AUTH_KEYS.users) || '{}'); } catch { return {}; }
      }
      function saveUsers(users) { localStorage.setItem(AUTH_KEYS.users, JSON.stringify(users)); }
      function persistUser(u) { localStorage.setItem(AUTH_KEYS.user, JSON.stringify(u)); }
      function restoreUser() { const raw = localStorage.getItem(AUTH_KEYS.user); if (!raw) return null; try { return JSON.parse(raw); } catch { return null; } }
      function openAuth() { authModal.classList.add('open'); }
      function closeAuth() { authModal.classList.remove('open'); }
      function switchAuthMode(isSignup) {
        nameRow.style.display = isSignup ? '' : 'none';
        authSubmit.textContent = isSignup ? 'Create account' : 'Sign in';
        authSubmit.dataset.mode = isSignup ? 'signup' : 'login';
        authTitle.textContent = isSignup ? 'Create your account' : 'Welcome back';
        tabSignIn.classList.toggle('active', !isSignup);
        tabSignUp.classList.toggle('active', isSignup);
        authError.style.display = 'none';
        authError.textContent = '';
      }
      logoutBtn.addEventListener('click', async () => {
        if (fb.auth) { try { await fb.auth.signOut(); } catch(e){} }
        setUser(null); localStorage.removeItem(AUTH_KEYS.user); openAuth();
      });
      tabSignIn.addEventListener('click', () => switchAuthMode(false));
      tabSignUp.addEventListener('click', () => switchAuthMode(true));
      authCancel.addEventListener('click', () => { authEmail.value=''; authPassword.value=''; closeAuth(); });
      authSubmit.addEventListener('click', async () => {
        const email = (authEmail.value || '').trim().toLowerCase();
        const password = authPassword.value || '';
        if (!email || !password) { alert('Enter email and password'); return; }
        if (fb.auth) {
          try {
            let cred = null;
            if (authSubmit.dataset.mode === 'signup') {
              cred = await fb.auth.createUserWithEmailAndPassword(email, password);
              // optional displayName
              if (authName.value) await cred.user.updateProfile({ displayName: authName.value });
            } else {
              cred = await fb.auth.signInWithEmailAndPassword(email, password);
            }
            const u = { email: cred.user.email, uid: cred.user.uid, name: cred.user.displayName || '' };
            persistUser(u); setUser(u); closeAuth();
          } catch (e) {
            authError.textContent = e.message || 'Authentication failed';
            authError.style.display = '';
          }
          return;
        }
        // local demo fallback
        const users = getUsers();
        if (authSubmit.dataset.mode === 'signup') {
          if (users[email]) { alert('Account already exists'); return; }
          users[email] = { email, password, name: authName.value || '' };
          saveUsers(users);
          persistUser(users[email]);
          setUser(users[email]);
          closeAuth();
        } else {
          const u = users[email];
          if (!u || u.password !== password) { alert('Invalid credentials'); return; }
          persistUser(u); setUser(u); closeAuth();
        }
      });

      // Initialize controls with saved settings
      startTimeEl.value = settings.start;
      endTimeEl.value = settings.end;

      function renderDaysChooser() {
        daysChooser.innerHTML = "";
        DAYS_ALL.forEach((d) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = d;
          btn.className = `chip ${settings.activeDays.includes(d) ? "active" : ""}`;
          btn.addEventListener("click", () => {
            const idx = settings.activeDays.indexOf(d);
            if (idx >= 0) settings.activeDays.splice(idx, 1); else settings.activeDays.push(d);
            // Keep order as DAYS_ALL
            settings.activeDays = DAYS_ALL.filter((x) => settings.activeDays.includes(x));
            saveSettings(settings);
            renderDaysChooser();
            // Align per-slot selected day with active days
            classSlots = classSlots.map(slot => {
              let chosen = slot.day;
              if (!settings.activeDays.includes(chosen)) {
                chosen = settings.activeDays[0] || DAYS_ALL[0];
              }
              return { ...slot, day: chosen };
            });
            renderSlots();
            renderTimetable();
          });
          daysChooser.appendChild(btn);
        });
      }

      // Time slots management for class creation
      let classSlots = [ { start: '09:00', end: '10:00', day: (settings.activeDays[0] || DAYS_ALL[0]), mode: 'Lecture' } ];
      function renderSlots() {
        timeSlotsEl.innerHTML = '';
        classSlots.forEach((slot, idx) => {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.gap = '8px';
          row.style.alignItems = 'center';

          const lbl1 = document.createElement('label'); lbl1.textContent = 'From';
          const sIn = document.createElement('input'); sIn.type = 'time'; sIn.value = slot.start;
          sIn.addEventListener('change', () => { classSlots[idx].start = sIn.value; });

          const lbl2 = document.createElement('label'); lbl2.textContent = 'To';
          const eIn = document.createElement('input'); eIn.type = 'time'; eIn.value = slot.end;
          eIn.addEventListener('change', () => { classSlots[idx].end = eIn.value; });

          const dayLbl = document.createElement('label'); dayLbl.textContent = 'Day';
          const daySel = document.createElement('select');
          (settings.activeDays.length ? settings.activeDays : DAYS_ALL).forEach((d) => {
            const opt = document.createElement('option');
            opt.value = d; opt.textContent = d; if (d === slot.day) opt.selected = true; daySel.appendChild(opt);
          });
          daySel.addEventListener('change', () => { classSlots[idx].day = daySel.value; });

          const modeLbl = document.createElement('label'); modeLbl.textContent = 'Type';
          const modeSel = document.createElement('select');
          ['Lecture', 'Lab', 'Online'].forEach((t) => {
            const o = document.createElement('option'); o.value = t; o.textContent = t; if (t === (slot.mode || 'Lecture')) o.selected = true; modeSel.appendChild(o);
          });
          modeSel.addEventListener('change', () => { classSlots[idx].mode = modeSel.value; });

          const del = document.createElement('button');
          del.type = 'button';
          del.className = 'btn secondary';
          del.textContent = 'Remove';
          del.addEventListener('click', () => {
            if (classSlots.length === 1) { classSlots[0] = { start: '09:00', end: '10:00', day: (settings.activeDays[0] || DAYS_ALL[0]), mode: 'Lecture' }; renderSlots(); return; }
            classSlots.splice(idx, 1); renderSlots();
          });

          row.appendChild(dayLbl); row.appendChild(daySel);
          row.appendChild(modeLbl); row.appendChild(modeSel);
          row.appendChild(lbl1); row.appendChild(sIn);
          row.appendChild(lbl2); row.appendChild(eIn);
          row.appendChild(del);
          const slotWrap = document.createElement('div');
          slotWrap.appendChild(row);
          slotWrap.style.border = '1px solid var(--border)';
          slotWrap.style.borderRadius = '8px';
          slotWrap.style.padding = '8px';
          slotWrap.style.background = 'var(--panel)';
          timeSlotsEl.appendChild(slotWrap);
        });
      }
      addSlotBtn.addEventListener('click', () => {
        classSlots.push({ start: '09:00', end: '10:00', day: (settings.activeDays[0] || DAYS_ALL[0]), mode: 'Lecture' });
        renderSlots();
      });

      // Merge adjacent or overlapping events for the same class on the same day
      function mergeEventsForRendering(eventsInput) {
        const byDayThenClass = new Map();
        for (const e of eventsInput) {
          if (!settings.activeDays.includes(e.day)) continue;
          const key = `${e.day}__${e.name.toLowerCase().trim()}`;
          if (!byDayThenClass.has(key)) byDayThenClass.set(key, []);
          byDayThenClass.get(key).push({ ...e });
        }

        const merged = [];
        for (const [key, list] of byDayThenClass.entries()) {
          list.sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
          let current = null;
          for (const item of list) {
            if (!current) { current = { ...item }; continue; }
            const curEnd = timeToMinutes(current.end);
            const nextStart = timeToMinutes(item.start);
            // If overlapping or touching, merge
            if (nextStart <= curEnd) {
              // Extend end if needed and prefer first color/name/day
              if (timeToMinutes(item.end) > curEnd) current.end = item.end;
            } else if (nextStart === curEnd) {
              if (timeToMinutes(item.end) > curEnd) current.end = item.end;
            } else {
              merged.push(current);
              current = { ...item };
            }
          }
          if (current) merged.push(current);
        }
        return merged;
      }

      function renderEventsList() {
        eventsContainer.innerHTML = "";
        if (events.length === 0) {
          const empty = document.createElement("div");
          empty.className = "event-item";
          empty.innerHTML = `<div class=\"event-summary\">No classes yet. Add one above.</div>`;
          eventsContainer.appendChild(empty);
          return;
        }
        // Group by class name; single row per class → clicking opens modal summary
        const byName = new Map();
        events.forEach((ev, idx) => {
          const key = ev.name.trim().toLowerCase();
          if (!byName.has(key)) byName.set(key, { name: ev.name.trim(), color: ev.color, slots: [] });
          byName.get(key).slots.push({ idx, ev });
        });

        const list = document.createElement('div');
        Array.from(byName.values())
          .sort((a,b) => a.name.localeCompare(b.name))
          .forEach(group => {
            const row = document.createElement('div');
            row.className = 'event-item';
            const colorDot = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${group.color};margin-right:8px;vertical-align:middle;"></span>`;
            const summary = document.createElement('div');
            summary.className = 'event-summary';
            summary.innerHTML = `${colorDot}<strong>${group.name}</strong>`;
            const open = document.createElement('button'); open.className = 'btn secondary'; open.textContent = 'View';
            open.addEventListener('click', () => {
              openClassDetailsByName(group.name);
            });
            row.appendChild(summary); row.appendChild(open);
            list.appendChild(row);
          });
        eventsContainer.appendChild(list);
      }

      function renderTimetable() {
        // Compute grid
        legendTimesEl.innerHTML = "";
        rowsEl.innerHTML = "";
        const startMin = timeToMinutes(settings.start);
        const endMin = timeToMinutes(settings.end);
        const step = settings.rowMinutes; // 30
        const totalSteps = Math.ceil((endMin - startMin) / step);
        const labelWidth = getLabelWidthPx();
        const containerWidth = (document.querySelector('.timetable.panel')?.clientWidth || 1000);
        let stepPx = Math.floor((containerWidth - labelWidth - 40) / Math.max(1, totalSteps));
        const isNarrow = window.innerWidth <= 600;
        const minStepPx = isNarrow ? 44 : 36;
        const maxStepPx = isNarrow ? 100 : 120;
        stepPx = clamp(stepPx, minStepPx, maxStepPx);

        // Top legend with times (label only at the hour marks)
        legendTimesEl.style.setProperty('--step-px', stepPx + 'px');
        legendTimesEl.style.gridTemplateColumns = `repeat(${totalSteps}, var(--step-px))`;
        for (let i = 0; i < totalSteps; i++) {
          const atMin = startMin + i * step;
          const cell = document.createElement('div');
          cell.className = 'legend-time-cell';
          if (atMin % 60 === 0) {
            const t12 = minutesToAmPm(atMin);
            cell.textContent = t12.replace(':00', '');
          } else {
            cell.textContent = '';
          }
          legendTimesEl.appendChild(cell);
        }

        // Rows for each active day
        settings.activeDays.forEach((day) => {
          const line = document.createElement('div');
          line.className = 'day-line';

          const label = document.createElement('div');
          label.className = 'day-label';
          label.textContent = day;

          const row = document.createElement('div');
          row.className = 'day-row';
          row.style.setProperty('--step-px', stepPx + 'px');
          row.style.width = (totalSteps * stepPx) + 'px';

          line.appendChild(label);
          line.appendChild(row);
          rowsEl.appendChild(line);
        });

        // Render merged event blocks horizontally
        const merged = mergeEventsForRendering(events);
        const dayToRow = {};
        Array.from(rowsEl.children).forEach((line) => {
          const day = line.querySelector('.day-label').textContent;
          dayToRow[day] = line.querySelector('.day-row');
        });

        for (const e of merged) {
          const row = dayToRow[e.day];
          if (!row) continue;
          const s = clamp(timeToMinutes(e.start), startMin, endMin);
          const t = clamp(timeToMinutes(e.end), startMin, endMin);
          if (t <= s) continue;
          const leftPx = ((s - startMin) / step) * stepPx + 2; // small inset
          const widthPx = ((t - s) / step) * stepPx - 4;

          const block = document.createElement('div');
          block.className = 'event-block';
          block.style.left = `${leftPx}px`;
          block.style.width = `${Math.max(12, widthPx)}px`;
          block.style.background = `linear-gradient(180deg, ${e.color}cc, ${e.color})`;
          block.style.borderColor = e.color;
          block.title = `${e.name} — ${e.day} ${e.start}–${e.end}`;
          const s12 = minutesToTime(s);
          const t12 = minutesToTime(t);
           const metaPieces = [];
           if (e.mode) metaPieces.push(e.mode);
           if (e.location) metaPieces.push(e.location);
           if (e.teacher) metaPieces.push(e.teacher);
           try { const arr = JSON.parse(e.notes||'[]'); if (Array.isArray(arr) && arr.length) metaPieces.push('📝'+arr.length); }
           catch { if (e.notes) metaPieces.push('📝'); }
          const metaText = metaPieces.join(' • ');
          block.innerHTML = `${e.name}${metaText ? `<span class=\"subtitle\">${metaText}</span>` : ''}<span class=\"subtitle\">${s12}–${t12}</span>`;
          block.addEventListener('click', () => openClassDetailsByName(e.name));
          row.appendChild(block);
        }
      }

      // ---------- Notes (global) ----------
      function renderNotesListGlobal() {
        notesListGlobalEl.innerHTML = '';
        if (!notesGlobal.length) {
          const empty = document.createElement('div');
          empty.className = 'event-item';
          empty.innerHTML = '<div class="event-summary">No notes yet. Use "New Note" to create one. If you added notes to a class earlier, import them below.</div>';
          notesListGlobalEl.appendChild(empty);
          // Offer import from class notes
          const importWrap = document.createElement('div');
          importWrap.className = 'row';
          const importBtn = document.createElement('button');
          importBtn.className = 'btn secondary';
          importBtn.textContent = 'Import notes from classes';
          importBtn.addEventListener('click', () => {
            // Scan events for embedded notes (string or JSON array)
            const extracted = [];
            events.forEach(ev => {
              if (!ev.notes) return;
              try {
                const arr = JSON.parse(ev.notes);
                if (Array.isArray(arr)) {
                  arr.forEach(it => { if (it && it.text) extracted.push(it.text); });
                } else if (typeof ev.notes === 'string') {
                  extracted.push(String(ev.notes));
                }
              } catch {
                extracted.push(String(ev.notes));
              }
            });
            if (!extracted.length) { alert('No notes found inside classes.'); return; }
            // create one consolidated note
            const id = crypto.randomUUID();
            const content = extracted.join('\n\n');
            notesGlobal = [{ id, title: 'Imported from classes', content, className: '', updatedAt: Date.now() }, ...notesGlobal];
            saveNotes(notesGlobal);
            renderNotesListGlobal();
            openNote(id);
          });
          importWrap.appendChild(importBtn);
          notesListGlobalEl.appendChild(importWrap);
          return;
        }
        // Ensure stable sort by updatedAt desc
        notesGlobal
          .slice()
          .sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0))
          .forEach(n => {
            const item = document.createElement('div'); item.className='note-list-item';
            const left = document.createElement('div'); left.className='note-title-mini'; left.textContent = n.title || 'Untitled';
            if (n.className) { left.title = `Class: ${n.className}`; }
            const openBtn = document.createElement('button'); openBtn.className='btn secondary'; openBtn.textContent='Open';
            openBtn.addEventListener('click', () => openNote(n.id));
            item.appendChild(left); item.appendChild(openBtn);
            notesListGlobalEl.appendChild(item);
          });
      }
      function clearNoteEditor() {
        activeNoteId = null; noteTitleEl.value = ''; noteContentEl.value = ''; if (noteClassEl) noteClassEl.value='';
      }
      function openNote(id) {
        const n = notesGlobal.find(x => x.id === id);
        if (!n) { clearNoteEditor(); return; }
        activeNoteId = n.id; noteTitleEl.value = n.title || ''; noteContentEl.value = n.content || ''; if (noteClassEl) noteClassEl.value = n.className || '';
      }
      // no preview now
      function populateNoteClassOptions() {
        if (!noteClassEl) return;
        const selected = noteClassEl.value;
        const names = Array.from(new Set(events.map(e => (e.name || '').trim()).filter(Boolean))).sort();
        noteClassEl.innerHTML = '<option value="">No class</option>' + names.map(n=>`<option value="${n}">${n}</option>`).join('');
        if (selected) {
          // Try to restore selection
          const opt = Array.from(noteClassEl.options).find(o=>o.value===selected);
          if (opt) noteClassEl.value = selected;
        }
      }
      addGlobalNoteBtn.addEventListener('click', async () => {
        const id = crypto.randomUUID();
        const now = Date.now();
        const n = { id, title: 'Untitled', content: '', className: noteClassEl ? noteClassEl.value : '', updatedAt: now };
        notesGlobal = [n, ...notesGlobal];
        await saveNotes(notesGlobal);
        try { notesGlobal = await loadNotes(); } catch {}
        renderNotesListGlobal();
        openNote(id);
      });
      saveGlobalNoteBtn.addEventListener('click', async () => {
        // If no active note, create one first
        if (!activeNoteId) {
          const id = crypto.randomUUID();
          const now = Date.now();
          const newNote = {
            id,
            title: (noteTitleEl.value || '').trim() || 'Untitled',
            content: noteContentEl.value || '',
            className: noteClassEl ? noteClassEl.value : '',
            updatedAt: now,
          };
          notesGlobal.unshift(newNote);
          activeNoteId = id;
        }
        const i = notesGlobal.findIndex(n => n.id === activeNoteId);
        if (i === -1) return;
        notesGlobal[i] = { ...notesGlobal[i], title: noteTitleEl.value.trim() || 'Untitled', content: noteContentEl.value, className: noteClassEl ? noteClassEl.value : '', updatedAt: Date.now() };
        const savedToCloud = await saveNotes(notesGlobal);
        // Ensure latest list is pulled from Firestore after write
        try { if (savedToCloud) notesGlobal = await loadNotes(); } catch {}
        renderNotesListGlobal();
      });
      deleteGlobalNoteBtn.addEventListener('click', async () => {
        if (!activeNoteId) return;
        const i = notesGlobal.findIndex(n => n.id === activeNoteId);
        if (i === -1) return;
        if (!confirm('Delete this note?')) return;
        notesGlobal.splice(i,1);
        await saveNotes(notesGlobal);
        renderNotesListGlobal();
        clearNoteEditor();
      });

      // Drawer helpers
      // Drawer state for multi-slot + multi-notes
      let editWorkingSlots = [];
      let editWorkingNotes = [];
      function renderEditSlots() {
        editTimeSlotsEl.innerHTML = '';
        (editWorkingSlots.length ? editWorkingSlots : []).forEach((slot, idx) => {
          const row = document.createElement('div');
          row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
          const dayLbl = document.createElement('label'); dayLbl.textContent = 'Day';
          const daySel = document.createElement('select');
          DAYS_ALL.forEach(d => { const o=document.createElement('option'); o.value=d; o.textContent=d; if (d===slot.day) o.selected=true; daySel.appendChild(o); });
          daySel.addEventListener('change', () => { editWorkingSlots[idx].day = daySel.value; });
          const fromLbl = document.createElement('label'); fromLbl.textContent = 'From';
          const sIn = document.createElement('input'); sIn.type='time'; sIn.value = slot.start; sIn.addEventListener('change', ()=>{ editWorkingSlots[idx].start = sIn.value; });
          const toLbl = document.createElement('label'); toLbl.textContent = 'To';
          const eIn = document.createElement('input'); eIn.type='time'; eIn.value = slot.end; eIn.addEventListener('change', ()=>{ editWorkingSlots[idx].end = eIn.value; });
          const del = document.createElement('button'); del.type='button'; del.className='btn secondary'; del.textContent='Remove';
          del.addEventListener('click', () => { editWorkingSlots.splice(idx,1); renderEditSlots(); });
          row.appendChild(dayLbl); row.appendChild(daySel);
          row.appendChild(fromLbl); row.appendChild(sIn);
          row.appendChild(toLbl); row.appendChild(eIn);
          row.appendChild(del);
          const wrap = document.createElement('div'); wrap.style.border='1px solid var(--border)'; wrap.style.borderRadius='8px'; wrap.style.padding='8px'; wrap.style.background='var(--panel)'; wrap.appendChild(row);
          editTimeSlotsEl.appendChild(wrap);
        });
      }
      function renderNotes() {
        notesListEl.innerHTML = '';
        (editWorkingNotes.length ? editWorkingNotes : []).forEach((note, idx) => {
          const item = document.createElement('div'); item.className='note-item';
          const txt = document.createElement('textarea'); txt.value = note.text || ''; txt.rows=2; txt.style.flex='1';
          txt.style.resize='vertical'; txt.style.background='#0b1220'; txt.style.color='var(--text)'; txt.style.border='1px solid var(--border)'; txt.style.borderRadius='8px'; txt.style.padding='8px';
          txt.addEventListener('input', () => { editWorkingNotes[idx].text = txt.value; });
          const del = document.createElement('button'); del.className='note-del'; del.textContent='Delete'; del.addEventListener('click', ()=>{ editWorkingNotes.splice(idx,1); renderNotes(); });
          item.appendChild(txt); item.appendChild(del);
          notesListEl.appendChild(item);
        });
      }
      function openDrawerForEvent(index) {
        const ev = events[index];
        if (!ev) return;
        editingIndex = index;
        editName.value = ev.name || '';
        editTeacher.value = ev.teacher || '';
        editLocation.value = ev.location || '';
        editColor.value = ev.color || '#60a5fa';
        // Build working slots by collecting all events with the same class name
        const normalized = (ev.name || '').trim().toLowerCase();
        editWorkingSlots = events
          .filter(x => (x.name || '').trim().toLowerCase() === normalized)
          .map(x => ({ id: x.id, day: x.day, start: x.start, end: x.end }));
        if (editWorkingSlots.length === 0) {
          editWorkingSlots = [{ day: DAYS_ALL[0], start: '09:00', end: '10:00' }];
        }
        renderEditSlots();
        // Notes: parse stored JSON array or fallback to single notes string
        try { editWorkingNotes = JSON.parse(ev.notes || '[]'); if (!Array.isArray(editWorkingNotes)) throw 0; }
        catch { editWorkingNotes = (ev.notes ? [{ text: ev.notes }] : []); }
        renderNotes();
        // Show global notes linked to this class
        if (linkedNotesEl) {
          const related = (notesGlobal || []).filter(n => (n.className || '').trim().toLowerCase() === (ev.name||'').trim().toLowerCase());
          linkedNotesEl.innerHTML = '';
          if (related.length) {
            related.forEach(n => {
              const item = document.createElement('div'); item.className='note-item';
              const txt = document.createElement('div'); txt.className='note-text'; txt.textContent = (n.title ? n.title + ': ' : '') + (n.content || '');
              item.appendChild(txt);
              linkedNotesEl.appendChild(item);
            });
          }
        }
        drawer.classList.add('open');
        drawerBackdrop.classList.add('open');
      }
      function closeDrawer() { drawer.classList.remove('open'); drawerBackdrop.classList.remove('open'); editingIndex = null; }
      closeDrawerBtn.addEventListener('click', closeDrawer);
      drawerBackdrop.addEventListener('click', closeDrawer);
      addEditSlotBtn.addEventListener('click', () => {
        editWorkingSlots.push({ day: DAYS_ALL[0], start: '09:00', end: '10:00' });
        renderEditSlots();
      });
      addNoteBtn.addEventListener('click', () => {
        editWorkingNotes.push({ text: '' });
        renderNotes();
      });
      function validateSlots(slots) {
        for (const s of slots) {
          if (!s.start || !s.end) return false;
          if (timeToMinutes(s.end) <= timeToMinutes(s.start)) return false;
        }
        return true;
      }
      saveOneBtn.addEventListener('click', () => {
        if (editingIndex == null) return;
        const base = events[editingIndex];
        if (!validateSlots(editWorkingSlots)) { alert('Please ensure each slot has valid start/end times.'); return; }
        const normalized = (base.name || '').trim().toLowerCase();
        // Remove all existing slots for this class
        events = events.filter(e => (e.name || '').trim().toLowerCase() !== normalized);
        // Add updated slots back
        editWorkingSlots.forEach(s => {
          events.push({
            id: crypto.randomUUID(),
            name: (editName.value.trim() || base.name),
            teacher: editTeacher.value.trim(),
            location: editLocation.value.trim(),
            mode: base.mode || 'Lecture',
            color: editColor.value || base.color,
            day: s.day,
            start: s.start,
            end: s.end,
            notes: JSON.stringify(editWorkingNotes)
          });
        });
        saveEvents(events);
        renderEventsList();
        renderTimetable();
        populateNoteClassOptions();
        // Refresh linked notes in drawer after save
        if (linkedNotesEl) {
          const related = (notesGlobal || []).filter(n => (n.className || '').trim().toLowerCase() === (editName.value||'').trim().toLowerCase());
          linkedNotesEl.innerHTML = '';
          related.forEach(n => { const item=document.createElement('div'); item.className='note-item'; const txt=document.createElement('div'); txt.className='note-text'; txt.textContent=(n.title?n.title+': ':'')+(n.content||''); item.appendChild(txt); linkedNotesEl.appendChild(item); });
        }
        closeDrawer();
      });
      deleteOneBtn.addEventListener('click', () => {
        if (editingIndex == null) return;
        const base = events[editingIndex];
        const normalized = (base.name || '').trim().toLowerCase();
        if (!confirm('Delete all time slots for this class?')) return;
        events = events.filter(e => (e.name || '').trim().toLowerCase() !== normalized);
        saveEvents(events);
        renderEventsList();
        renderTimetable();
        closeDrawer();
      });
      function openClassDetailsByName(targetName) {
        const normalized = (targetName || '').trim().toLowerCase();
        const matches = events
          .map((ev, i) => ({ ev, i }))
          .filter(({ ev }) => (ev.name || '').trim().toLowerCase() === normalized)
          .sort((a,b) => DAYS_ALL.indexOf(a.ev.day) - DAYS_ALL.indexOf(b.ev.day) || timeToMinutes(a.ev.start) - timeToMinutes(b.ev.start));
        if (matches.length === 0) return;
        // open first matching slot in drawer; user can use controls to adjust/change
        openDrawerForEvent(matches[0].i);
      }

      // Handlers
      window.addEventListener('resize', () => { renderTimetable(); });
      applyTimeBtn.addEventListener("click", () => {
        const s = startTimeEl.value;
        const e = endTimeEl.value;
        if (!s || !e) return;
        if (timeToMinutes(e) <= timeToMinutes(s)) {
          alert("End time must be after start time.");
          return;
        }
        settings.start = s;
        settings.end = e;
        saveSettings(settings);
        renderTimetable();
      });

      addClassBtn.addEventListener("click", () => {
        const name = (classNameEl.value || "").trim();
        const color = classColorEl.value || "#60a5fa";
        const teacher = (document.getElementById('teacherName')?.value || '').trim();
        const location = (document.getElementById('location')?.value || '').trim();
        const notes = (document.getElementById('notes')?.value || '').trim();
        if (!name) { alert("Please enter a class name."); return; }
        if (classSlots.length === 0) { alert("Add at least one time slot."); return; }

        const newEvents = [];
        for (const sl of classSlots) {
          const s = sl.start; const e = sl.end; const d = sl.day;
          if (!s || !e) { alert("Please set start and end time for all slots."); return; }
          if (timeToMinutes(e) <= timeToMinutes(s)) { alert(`End time must be after start time for ${s}–${e}.`); return; }
          if (!d) { alert("Select a day for each slot."); return; }
          newEvents.push({ id: crypto.randomUUID(), name, day: d, start: s, end: e, color, teacher, location, mode: sl.mode || 'Lecture', notes });
        }
        events.push(...newEvents);
        saveEvents(events);
        classNameEl.value = "";
        // Reset slots
        classSlots = [{ start: '09:00', end: '10:00', day: (settings.activeDays[0] || DAYS_ALL[0]), mode: 'Lecture' }];
        renderSlots();
        renderEventsList();
        renderTimetable();
        populateNoteClassOptions();
        // Close modal after adding
        if (typeof closeModal === 'function') closeModal();
      });

      clearAllBtn.addEventListener("click", () => {
        if (!confirm("Remove all classes?")) return;
        events = [];
        saveEvents(events);
        renderEventsList();
        renderTimetable();
      });

      // Tabs behavior
      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          tabButtons.forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
          // Show/hide panels
          if (btn.dataset.tab === 'tab-notes') {
            ttPanel.style.display = 'none';
            notesPanel.style.display = 'block';
            // Refresh class options and notes list on view
            populateNoteClassOptions();
            renderNotesListGlobal();
          } else {
            ttPanel.style.display = 'block';
            notesPanel.style.display = 'none';
          }
        });
      });

      // Initial render
      renderDaysChooser();
      renderSlots();
      const restored = restoreUser();
      if (fb.auth) {
        fb.auth.onAuthStateChanged((u) => {
          if (u) { const su = { email: u.email, uid: u.uid, name: u.displayName || '' }; persistUser(su); setUser(su); closeAuth(); }
          else { setUser(null); openAuth(); }
        });
      } else {
        if (restored) { setUser(restored); closeAuth(); } else { openAuth(); }
      }
      Promise.resolve(loadEvents()).then((e) => { events = e; renderEventsList(); renderTimetable(); populateNoteClassOptions(); });
      // Ensure notes load at boot even before auth events settle (local demo mode)
      Promise.resolve(loadNotes()).then((n) => { notesGlobal = n; renderNotesListGlobal(); });

      // Modal behavior
      function openModal() { modal.classList.add('open'); }
      function closeModal() { modal.classList.remove('open'); }
      openAddModalBtn.addEventListener('click', openModal);
      closeModalBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    </script>
  </body>
</html>


